name: Deploy Streamlit App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify lightweight dashboard data
      run: |
        echo "Checking for lightweight dashboard data..."
        if [ ! -d "analysis_results/dashboard_data" ]; then
          echo "ERROR: Dashboard data directory not found!"
          exit 1
        fi
        
        echo "Dashboard data files:"
        ls -lh analysis_results/dashboard_data/*.json
        
        echo ""
        echo "Total dashboard data size:"
        du -sh analysis_results/dashboard_data/
        
        # Verify key files exist
        required_files=(
          "visual_features_summary.json"
          "linguistic_features_summary.json"
          "social_engagement_summary.json"
          "dataset_overview_summary.json"
          "authenticity_analysis_summary.json"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "analysis_results/dashboard_data/$file" ]; then
            echo "ERROR: Required file missing: $file"
            exit 1
          fi
        done
        
        echo "âœ“ All required dashboard data files present"
    
    - name: Test Streamlit app
      run: |
        streamlit run app.py --server.headless true --server.port 8501 &
        sleep 10
        curl -f http://localhost:8501 || exit 1
        pkill -f streamlit
    
    - name: Deploy to Streamlit Cloud
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "App ready for Streamlit Cloud deployment"
        echo "Visit: https://share.streamlit.io/ and connect your GitHub repo"